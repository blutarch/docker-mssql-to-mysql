# MSSQL Backups to MySQL

The DBDump tool used to be run on a remote server. All this process can now be done inside a docker container running MSSQL. Mono is an open source implementation of Microsoft's .NET Framework that we also use to run the DBDump tool, since it was initially written in C#.

This is a work in progress, feel free to make some changes to the process below if needed.

## Initial Setup

1. Create a directory where the data will be converted (e.g. `~/workspace/dumps/.data-conversion`). This directory will be referred as `[DATA_DIR]` below.

2. Clone the [vanilla/dbdump](https://github.com/vanilla/dbdump) inside your [DATA_DIR].

3. Run `git fetch` inside the "dbdump" repo then checkout the `linux/dbdump` branch.

4. Clone the [migrations](https://github.com/vanilla/migrations) with your other repositories (e.g. `~/workspace/repos`).

5. Navigate inside the `docker-mssql` folder of the "migrations" repository and run `docker build . -t sql_server  --platform linux/amd64`.

## Running the MSSQL server

Inside the `.../migrations/docker-mssql` folder, run the command below.

**IMPORTANT: You need to replace the `src` with the [DATA_DIR] path.**

```bash
docker run -it -p 1433:1433 --mount src=[DATA_DIR],target=/hostvolume,type=bind -e 'ACCEPT_EULA=Y' -e 'MSSQL_SA_PASSWORD=Y0urStrongPassword1' sql_server
```

This might take a while the first time.

Congratulations, you now have a container running MSSQL on your machine!

## Importing a bak file

### Using the CLI (recommended)

This can be done with the CLI using the [sqlcmd command](https://docs.microsoft.com/en-us/sql/linux/sql-server-linux-backup-and-restore-database?view=sql-server-ver15).

1. Move the `.bak` file into your [DATA_DIR].
2. Copy the `restore.sql` from the `.../migrations/docker-mssql` into your [DATA_DIR].
3. Modify the `@NewDatabaseName` and `@TemplateBackups`. Your [DATA_DIR] is mounted as `/hostvolume`, so do not remove it from the path when setting `@TemplateBackups`.
4. Run `docker ps` and retrieve the name of your running container.
5. Log into the container by running the command below.

**Replace `[CONTAINER_NAME]` with the name of the container.**

```bash
docker exec -e COLUMNS="`tput cols`" -e LINES="`tput lines`" -ti --user root [CONTAINER_NAME] bash
```

6. Execute the `restore.sql` script by running the command below.

**You will be prompted for a password, it is `Y0urStrongPassword1`.**

```bash
sqlcmd -S localhost -U SA -i /hostvolume/restore.sql
```

At this point, the restoration should be complete. Now go on to the next step: **Running the DB Dump tool**

### Using Azure Data Studio (optional)

Azure Data Studio is a cross-platform database tool that can run on MacOS. Install this only if you need to see the data before the conversion or if you need to import a BACPAC file.

1. Install Azure Data Studio [from here](https://docs.microsoft.com/en-us/sql/azure-data-studio/download?view=sql-server-2017)
2. Connect to the local server (host: localhost, user: sa, password: Y0urStrongPassword1)
3. Move the file you want to convert to your `docker-mssql` folder and import the database from Azure Data Studio. The file will be located inside the `/hostvolume` directory.

## Running the DB Dump tool

If you are already on the container, you can go to step 3.

1. Run `docker ps` and retrieve the name of your running container.
2. Log into the container by running the command below.

**Replace `[CONTAINER_NAME]` with the name of the container.**

```bash
docker exec -e COLUMNS="`tput cols`" -e LINES="`tput lines`" -ti --user root [CONTAINER_NAME] bash
```

3. Navigate inside the `/hostvolume` directory and run the dbdump tool using mono.

```bash
mono dbdump/bin/Release/dbdump.exe [dbname] [foldername]
```

5. Wait for the process to finish and exit the container.


## Importing to MySQL

1. Go back to your [DATA_DIR], you will find a folder with the exported files.
2. Open the `import.sql` file generated by the dbdump tool and update the path to the text files.
3. In SequelAce, add the [DATA DIR] folder to the list of autorized folders (Preferences => File => Add File)
4. Make sure the database accept files by running `SET GLOBAL local_infile=1;`.
5. Create a new database and import the `import.sql` file.
